<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Service Bus - Self-Service Portal</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="css/create-resource.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-text">
        Digital Health Infrastructure Self Service Tooling
      </div>
      <div class="user-controls">
        <!-- Required by auth.js -->
        <button id="login-button" style="display: none;">Login</button>
        <span id="username">Not logged in</span>
        <button id="logout-button" onclick="location.href='index.html'">
          Logout
        </button>
      </div>
    </header>

    <!-- Main content -->
    <main class="main-container">
      <div class="sidebar">
        <div class="sidebar-header">
          <img
            src="assets/tandem-diabetes-logo.png"
            alt="Tandem Diabetes Care Logo"
            class="sidebar-logo"
          />
          <div class="sidebar-title">Self-Service Portal</div>
        </div>
        <nav class="sidebar-nav">
          <ul>
            <li>
              <a href="dashboard.html">
                <svg viewBox="0 0 24 24" width="24" height="24">
                  <path
                    fill="currentColor"
                    d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
                  ></path>
                </svg>
                Dashboard
              </a>
            </li>
            <li>
              <a href="#">
                <svg viewBox="0 0 24 24" width="24" height="24">
                  <path
                    fill="currentColor"
                    d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"
                  ></path>
                </svg>
                Resources
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <div class="content">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
          <a href="dashboard.html">Dashboard</a> &gt;
          <span id="resource-breadcrumb">Create Service Bus</span>
        </div>

        <!-- Loading indicator -->
        <div
          id="loading"
          style="display: none; text-align: center; margin: 2rem 0;"
        >
          <svg
            width="38"
            height="38"
            viewBox="0 0 38 38"
            xmlns="http://www.w3.org/2000/svg"
            stroke="#00678e"
          >
            <g fill="none" fill-rule="evenodd">
              <g transform="translate(1 1)" stroke-width="2">
                <circle stroke-opacity=".5" cx="18" cy="18" r="18" />
                <path d="M36 18c0-9.94-8.06-18-18-18">
                  <animateTransform
                    attributeName="transform"
                    type="rotate"
                    from="0 18 18"
                    to="360 18 18"
                    dur="1s"
                    repeatCount="indefinite"
                  />
                </path>
              </g>
            </g>
          </svg>
          <div style="margin-top: 10px">Processing your request...</div>
        </div>

        <!-- Hidden elements to satisfy auth.js and forms.js -->
        <div id="resource-selector" style="display: none;"></div>
        <div id="resource-buttons" style="display: none;"></div>

        <!-- Form container for Service Bus -->
        <div id="resource-form-container" class="resource-form-container">
          <div class="resource-header">
            <!-- Changed id from "resource-title" to "form-title" to match forms.js expectation -->
            <h1 id="form-title">Create Service Bus</h1>
            <button class="back-button" onclick="location.href='dashboard.html'">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <path
                  fill="currentColor"
                  d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
                ></path>
              </svg>
              Back to Dashboard
            </button>
          </div>

          <div class="form-container">
            <form id="resource-form">
              <div id="form-fields"></div>
              <div id="environment-selector"></div>

              <div class="form-section">
                <h3>Validation and Approval</h3>
                <p class="info-text">
                  Resources created in production environments require additional
                  approval.
                </p>
              </div>

              <div class="form-actions">
                <button
                  type="button"
                  class="secondary-button"
                  onclick="location.href='dashboard.html'"
                >
                  Cancel
                </button>
                <button type="submit" class="primary-button">
                  Submit Request
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Confirmation message -->
        <div
          id="confirmation-message"
          class="confirmation-message"
          style="display: none;"
        ></div>

        <!-- Result message container -->
        <div id="result-message" style="display: none;"></div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/service-bus-form.js"></script>
    <script src="js/servicebus-api.js"></script>
    <script>
      // When the document loads, wait until auth.js has set the GitHub token
      // and loaded the permissions. auth.js assigns the token to window.token and
      // permissions to window.permissions.
      document.addEventListener("DOMContentLoaded", function () {
        // Poll until both token and permissions are available.
        const waitForAuth = setInterval(() => {
          if (window.token && window.permissions) {
            clearInterval(waitForAuth);
            // Immediately load the Service Bus form (resourceType: "ServiceBusTopic")
            loadResourceForm("ServiceBusTopic", window.permissions);
          }
        }, 100);
      });
    </script>
  </body>
</html>
